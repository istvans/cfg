#!/usr/bin/env bash
#=================================== FUNC =====================================
function force_home_links
{
     for file in $@; do
         ln -sf $CFG_DIR/$file $HOME/.
         if [ "$MALNA" = true ]; then
             sudo ln -sf $HOME/$file ~root/.
         fi
     done
}
#==============================================================================
function find_expressvpn_installer
{
    INSTALLER_DIR=$1
    find $INSTALLER_DIR -maxdepth 1 -name 'expressvpn*' -print -quit
}
#==============================================================================
#=================================== MAIN =====================================
#==============================================================================
CFG_DIR=$HOME/cfg
if [ ! -d $CFG_DIR ]; then
    if [[ "$(basename $PWD)" = "$CFG_DIR" ]]; then
        CFG_DIR=$PWD
    else
        echo "ERROR Cannot find the $CFG_DIR directory!" >&2
        exit 1
    fi
fi

. $CFG_DIR/argparse  # import MALNA, BATCH_MODE
. $CFG_DIR/.bash_functions  # import is_installed, fatal_error, crashburn, warn, info, error
. $CFG_DIR/.bash_envars  # import AUTOTEVE_CFG, EDITOR, LANG, VPN_INSTALL_ADDRESS and many more...

info "CFG_DIR:'$CFG_DIR'"

if $BATCH_MODE; then
    ASSUME_YES="--assume-yes"
else
    ASSUME_YES=""
fi

if [ ! $(is_installed git) ]; then
    fatal_error "missing git? this script should have been git cloned!"
fi

info "setup locale..."
DEFAULT_LOCALE=/etc/default/locale
if [[ ! -f $DEFAULT_LOCALE || "$(tail -n1 /etc/default/locale | cut -f2 -d =)" != "$LANG" ]]; then
    if $BATCH_MODE; then
        # TODO Is there a way to do this in a non-interactive way?
        fatal_error "$DEFAULT_LOCALE setup is needed which cannot be done in batch mode"
    fi
    sudo dpkg-reconfigure locales
    sudo update-locale
fi
info OK

BIN_DIR=$HOME/bin
if [ ! -d $BIN_DIR ]; then
    mkdir $BIN_DIR
    crashburn
fi
info "BIN_DIR:'$BIN_DIR'"

info "let's start with making sure we have all the essential apps..."
if [ "$MALNA" = true ]; then
    sudo apt-get update
    sudo apt-get $ASSUME_YES install build-essential cron htop make man procps transmission-daemon vim \
        wget network-manager
else
    if [ ! $(is_installed vim) ]; then
        fatal_error "vim is missing!"
    fi
fi

info @single_line_start@ "setup git..."
git config --global user.email "stevesiroki@gmail.com"
git config --global user.name "István Siroki"
git config --global core.editor "vim"
git config --global alias.lg "log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit"
if [ "$MALNA" = true ]; then
    git config --global credential.helper 'cache --timeout=3600'
fi
info @single_line_end@ OK

info @single_line_start@ "setup vim..."
TYPE_SCRIPT_SYNTAX="typescript-vim"
TYPE_SCRIPT_SYNTAX_DIR="$HOME/.vim/pack/typescript/start"
if [ ! -d $TYPE_SCRIPT_SYNTAX_DIR ]; then
    mkdir -p $TYPE_SCRIPT_SYNTAX_DIR
    git clone https://github.com/leafgarland/$TYPE_SCRIPT_SYNTAX.git $TYPE_SCRIPT_SYNTAX_DIR/$TYPE_SCRIPT_SYNTAX
fi
info @single_line_end@ OK

info @single_line_start@ "setup bash..."
force_home_links .bash_profile .bashrc .bash_aliases .bash_envars .bash_functions .vimrc
info @single_line_end@ OK

if [ "$MALNA" = true ]; then
    BASH_GIT_PROMPT_DIR=$HOME/$BASH_GIT_PROMPT
    if [ ! -d $BASH_GIT_PROMPT_DIR ]; then
        git clone https://github.com/magicmonty/bash-git-prompt.git $BASH_GIT_PROMPT_DIR --depth=1
    fi

    PYTHON3=python3.9
    info @single_line_start@ "detect $PYTHON3..."
    if [ $(is_installed $PYTHON3) ]; then
        info @single_line_end@ $($PYTHON3 --version)
        crashburn
    else
        info @single_line_end@ MISSING
        SETUP_TIME_ESTIMATE_H=2.5
        if $BATCH_MODE; then
            warn "Failed to detect $PYTHON3... installing it (takes ~$SETUP_TIME_ESTIMATE_H hours)..."
            choice="y"
        else
            read -p "Failed to detect $PYTHON3... shall we build it (takes ~$SETUP_TIME_ESTIMATE_H hours)? (y/n) " choice
        fi
        if [ "$choice" = "y" ]; then
            start=$(date +%s)

            info "... prerequisites ..."
            sudo apt-get $ASSUME_YES install openssl zlib1g-dev libffi-dev

            info @single_line_start@ "... determining the system's openssl version:"
            # without this build the ssl python module would be missing
            # we use the same version what we have on the system thus at the end this whole build
            # can be removed i.e. it is only needed while building $PYTHON3
            OPEN_SSL_VERSION=$(openssl version | grep -oP "\d+\.\d+\.\d+[^ ]+")
            crashburn
            info @single_line_end@ "$OPEN_SSL_VERSION ..."
            OPEN_SSL=openssl-$OPEN_SSL_VERSION
            SOURCE_TAR=$OPEN_SSL.tar.gz

            SSL_SOURCE_ADDRESS=https://www.openssl.org/source/$SOURCE_TAR
            info "... download $SSL_SOURCE_ADDRESS ..."
            SSL_INSTALL_DIR=/opt/openssl
            sudo mkdir -p $SSL_INSTALL_DIR >/dev/null 2>&1
            sudo wget -c $SSL_SOURCE_ADDRESS --directory-prefix=$SSL_INSTALL_DIR
            crashburn

            info "... unpack $SOURCE_TAR ..."
            sudo tar -xzf $SSL_INSTALL_DIR/$SOURCE_TAR --directory=$SSL_INSTALL_DIR
            crashburn

            cd $SSL_INSTALL_DIR/$OPEN_SSL
            crashburn

            info "... configure $OPEN_SSL ..."
            sudo ./config -fPIC -shared --prefix=$SSL_INSTALL_DIR --openssldir=$SSL_INSTALL_DIR
            crashburn

            info "... build $OPEN_SSL ..."
            sudo make
            crashburn

            info "... install $OPEN_SSL under $SSL_INSTALL_DIR ..."
            sudo make install
            crashburn

            cd -
            crashburn

            PY_BUILD_DIR=/tmp/python_build
            info "... creating $PY_BUILD_DIR ..."
            mkdir -p $PY_BUILD_DIR >/dev/null 2>&1

            cd $PY_BUILD_DIR
            crashburn

            PY_CONFIG_DIR=Python-3.9.0
            PY_TAR_FILE=$PY_CONFIG_DIR.tgz
            PY_SOURCE_ADDRESS=https://www.python.org/ftp/python/3.9.0/$PY_TAR_FILE
            info "... download $PY_SOURCE_ADDRESS ..."
            wget -c $PY_SOURCE_ADDRESS
            crashburn

            info "... unpack $PY_TAR_FILE ..."
            tar -xzf $PY_TAR_FILE
            crashburn

            info "... configure $PYTHON3 ..."
            PY_SETUP=$PY_CONFIG_DIR/Modules/Setup
            sed --in-place '
                /SSL=/,/$(SSL).*[^\\]$/ {
                    s/^#//
                    s#^\(SSL=\).*$#\1/'$SSL_INSTALL_DIR'#
                }
            ' $PY_SETUP
            PY_TARGET=/opt/$PYTHON3
            $PY_CONFIG_DIR/configure --with-openssl=$SSL_INSTALL_DIR --prefix=$PY_TARGET --enable-optimizations
            crashburn

            info "... build $PYTHON3 ..."
            export LD_LIBRARY_PATH=$SSL_INSTALL_DIR/lib
            make
            crashburn

            info "... install $PYTHON3 ..."
            sudo make install
            crashburn
            sudo ln -sf $PY_TARGET/bin/python3 /usr/bin/$PYTHON3
            crashburn

            info "... install pip and pipenv ..."
            wget https://bootstrap.pypa.io/get-pip.py
            crashburn
            $PYTHON3 ./get-pip.py
            crashburn
            $PYTHON3 -m pip install pipenv
            crashburn

            cd -
            crashburn

            info "... cleanup ..."
            sudo rm -rf $PY_BUILD_DIR
            crashburn
            sudo rm -rf $SSL_INSTALL_DIR
            crashburn

            end=$(date +%s)
            runtime=$((end-start))
            info "done (took ${runtime}s)"
        else
            info skipped
        fi
    fi

    if [ $(is_installed $PYTHON3) ]; then
        info "install $PYTHON3 dependent apps..."

        info "... setup autoteve ..."
        if [ ! -d "$AUTOTEVE_SRC_DIR" ]; then
            git clone https://github.com/istvans/autoteve.git $AUTOTEVE_SRC_DIR
            crashburn
        else
            info "...... no download; using the found source ......"
        fi

        cd $AUTOTEVE_SRC_DIR
        $PYTHON3 -m pipenv install
        crashburn
        cd -

        if [ ! -f $AUTOTEVE_CFG ]; then
            if $BATCH_MODE; then
                warn "You will need to create $AUTOTEVE_CFG before the next schedule"
            else
                mkdir -p $AUTOTEVE_CFG_DIR 2>/dev/null
                chmod 700 $AUTOTEVE_CFG_DIR
                crashburn
                touch $AUTOTEVE_CFG
                crashburn
                chmod 600 $AUTOTEVE_CFG
                crashburn
                echo "please configure autoteve" >&2
                sleep 5
                $EDITOR $AUTOTEVE_CFG
                crashburn
            fi
        fi
        info OK
    else
        warn "Cannot install $PYTHON3 dependent apps! $PYTHON3 is missing"
    fi

    DIGI_DIR=$HOME/digionline
    if [ ! -d $DIGI_DIR ]; then
        info "setup digionline under $DIGI_DIR..."
        git clone https://github.com/istvans/digionline.git $DIGI_DIR
        DIGI_INSTALLER=$DIGI_DIR/osmc_installer.sh
        if $BATCH_MODE; then
            # TODO implement batch mode in osmc_installer.sh?
            warn "Run $DIGI_INSTALLER after this setup (needs interactive mode)"
        else
            sudo $DIGI_INSTALLER
            crashburn
        fi
    fi

    info @single_line_start@ "detect expressvpn..."
    if [ $(is_installed expressvpn) ]; then
        info @single_line_end@ $(expressvpn --version)
        crashburn
    else
        info @single_line_end@ MISSING
        INSTALLER_DIR=/tmp/
        express_vpn_installer="$(find_expressvpn_installer $INSTALLER_DIR)"
        if [[ -z "$express_vpn_installer" ]]; then
            info "downlad expressvpn from $VPN_INSTALL_ADDRESS..."
            wget -c $VPN_INSTALL_ADDRESS --directory-prefix=$INSTALLER_DIR
            crashburn
            express_vpn_installer="$(find_expressvpn_installer $INSTALLER_DIR)"
            crashburn
            info OK
        fi

        info "setup expressvpn using $express_vpn_installer..."
        sudo dpkg -i $express_vpn_installer
        crashburn
        info "cleanup installer..."
        rm $express_vpn_installer
        crashburn
        if $BATCH_MODE; then
            warn "Activate the account and run the below steps manually"
        else
            WAIT_FOR_VPN_DAEMON=5
            info "Waiting $WAIT_FOR_VPN_DAEMON seconds before trying to activate"
            expressvpn activate
            expressvpn autoconnect on
            expressvpn connect $VPN_SERVER
        fi
    fi
    expressvpn preferences

    info @single_line_start@ "install VPN monitor..."
    ln -sf $CFG_DIR/monvpn $BIN_DIR/monvpn
    info @single_line_end@ OK

    info "setup odrive..."
    if [ ! -d $ODRIVE_BIN_PATH ]; then
        mkdir -p $ODRIVE_BIN_PATH
    fi
    if [ ! -f $ODRIVE_AGENT ]; then
        wget https://dl.odrive.com/odriveagent-rpi --output-document=- | tar -xz --directory=$ODRIVE_BIN_PATH
        if [ ! -f $ODRIVE_AGENT ]; then
            fatal_error "Failed to install '$ODRIVE_AGENT'"
        fi
    fi
    if [ ! -f $ODRIVE ]; then
        wget https://dl.odrive.com/odrive-py --output-document=$ODRIVE
        if [ ! -f $ODRIVE ]; then
            fatal_error "Failed to install '$ODRIVE'"
        fi
    fi
    if [ ! -f $ODRIVE_AUTH_KEY_FILE ]; then
        if $BATCH_MODE; then
            warn "Please create $ODRIVE_AUTH_KEY_FILE before the next reboot"
        else
            touch $ODRIVE_AUTH_KEY_FILE
            chmod 600 $ODRIVE_AUTH_KEY_FILE
            read -p "please type in your secret odrive auth key: " auth_key
            echo "$auth_key" > $ODRIVE_AUTH_KEY_FILE
            chmod 400 $ODRIVE_AUTH_KEY_FILE
            . $CFG_DIR/.bash_envars  # to populate ODRIVE_AUTH_KEY from the new file
            if [[ -z "$ODRIVE_AUTH_KEY" ]]; then
                fatal_error "The odrive auth key is still empty... ¯\_(ツ)_/¯"
            fi
        fi
    fi
    ln -sf $CFG_DIR/odrive_common $BIN_DIR/odrive_common
    ln -sf $CFG_DIR/odrive_agent $BIN_DIR/odrive_agent
    ln -sf $CFG_DIR/odrive_sync $BIN_DIR/odrive_sync
    ln -sf $CFG_DIR/monodrive $BIN_DIR/monodrive
    info OK

    OLD_CRON="/var/tmp/crontab.old"
    info @single_line_start@ "saving old crontab to '$OLD_CRON'..."
    crontab -l > $OLD_CRON
    info @single_line_end@ OK

    info @single_line_start@ "install crontab..."
    crontab $CFG_DIR/cron
    info @single_line_end@ OK

    info "setup transmission..."
    sudo systemctl stop transmission-daemon
    TRANSMISSION_DAEMON_CFG=/etc/transmission-daemon/settings.json
    if $BATCH_MODE; then
        warn "To configure the transmission daemon stop it, edit $TRANSMISSION_DAEMON_CFG, then restart it"
    else
        echo "please configure the daemon" >&2
        sleep 5
        sudo $EDITOR $TRANSMISSION_DAEMON_CFG
    fi
    sudo usermod -a -G debian-transmission $USER
    START_DAEMON_CMD=sudo systemctl start transmission-daemon
    sudo systemctl start transmission-daemon
    ln -sf $CFG_DIR/bounce_transmission $BIN_DIR/bounce_transmission
    info OK

    info "setup samba..."
    sudo apt-get $ASSUME_YES install smb-app-osmc
    crashburn
    sudo cp $CFG_DIR/smb-shares.conf /etc/samba/smb-shares.conf
    crashburn
    SAMBA_SERVICE=smbd
    SAMBA_MAGIC_WORD=titok
    if $(sudo pdbedit -u $USER -f | grep $SAMBA_MAGIC_WORD >/dev/null); then
        info "...$USER was already setup✅..."
    else
        SAMBA_PASSWD="smbpasswd -a $USER"
        if $BATCH_MODE; then
            warn "To set the samba password run $SAMBA_PASSWD; then restart $SAMBA_SERVICE"
        else
            sudo $SAMBA_PASSWD
            crashburn
            sudo pdbedit -u $USER -f $SAMBA_MAGIC_WORD
            crashburn
        fi
    fi
    info "...restarting the samba service..."
    sudo service $SAMBA_SERVICE restart
    crashburn
    info OK
fi

info "We are ready to go!"

